<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Sistema de Gestión Académica</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/css/dashboard.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 0;
      margin-bottom: 2rem;
    }
    
    .nav-menu {
      background: white;
      padding: 1rem 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    .nav-menu .nav-link {
      color: #495057;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    
    .nav-menu .nav-link:hover {
      background-color: #e9ecef;
      color: #007bff;
    }
    
    .nav-menu .nav-link.active {
      background-color: #007bff;
      color: white;
    }

    .students-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
    }

    .stat-content h3 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
      color: #2c3e50;
    }

    .stat-content p {
      margin: 0;
      color: #6c757d;
      font-size: 0.9rem;
    }

    .students-table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .table-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-header h3 {
      margin: 0;
      color: #2c3e50;
    }

    .search-box {
      position: relative;
      width: 300px;
    }

    .search-box input {
      padding-right: 2.5rem;
    }

    .search-box i {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .students-table {
      margin: 0;
    }

    .students-table th {
      background: #f8f9fa;
      border-top: none;
      font-weight: 600;
      color: #495057;
      padding: 1rem;
    }

    .students-table td {
      padding: 1rem;
      vertical-align: middle;
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .student-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .student-details strong {
      color: #2c3e50;
    }

    .project-link {
      color: #007bff;
      text-decoration: none;
      font-weight: 500;
    }

    .project-link:hover {
      text-decoration: underline;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
    }

    .status-activo { background: #d4edda; color: #155724; }
    .status-completado { background: #cce5ff; color: #004085; }
    .status-pausado { background: #fff3cd; color: #856404; }

    .contact-info {
      font-size: 0.9rem;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .contact-item i {
      width: 12px;
      color: #6c757d;
    }

    .contact-item a {
      color: #007bff;
      text-decoration: none;
    }

    .contact-item a:hover {
      text-decoration: underline;
    }

    .date-text {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
    }

    .student-row.inactive {
      opacity: 0.6;
      background-color: #f8f9fa;
    }

    .student-row.inactive .student-avatar {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    .student-row.inactive .student-details strong {
      color: #6c757d;
    }

    .student-row.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h3 mb-0">
          <i class="fas fa-graduation-cap me-2"></i>
          Sistema de Gestión Académica
        </h1>
        <div class="d-flex align-items-center">
          <span class="me-3">Bienvenido, <%= user.nombres %></span>
          <a href="/auth/logout" class="btn btn-outline-light btn-sm">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
          </a>
        </div>
      </div>
    </div>
  </header>

  <nav class="nav-menu">
    <div class="container">
      <ul class="nav nav-pills">
        <li class="nav-item">
          <a class="nav-link" href="/dashboard">
            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/coordinator/projects">
            <i class="fas fa-project-diagram me-1"></i> Mis Proyectos
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/coordinator/students">
            <i class="fas fa-users me-1"></i> Estudiantes
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/coordinator/deliverables">
            <i class="fas fa-file-alt me-1"></i> Entregables
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/coordinator/reports">
            <i class="fas fa-chart-bar me-1"></i> Reportes
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/coordinator/calendar">
            <i class="fas fa-calendar me-1"></i> Calendario
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="dashboard-container">
      <div class="dashboard-header">
        <h1><i class="fas fa-users"></i> <%= title %></h1>
        <p class="text-muted">Estudiantes de los proyectos bajo tu coordinación</p>
      </div>

      <div class="students-stats">
        <div class="stat-card">
          <div class="stat-icon bg-primary">
            <i class="fas fa-user-graduate"></i>
          </div>
          <div class="stat-content">
            <h3><%= students.length %></h3>
            <p>Total Estudiantes</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon bg-success">
            <i class="fas fa-project-diagram"></i>
          </div>
          <div class="stat-content">
            <h3><%
              let activosCount = 0;
              students.forEach(s => {
                if (s.proyecto_estado === 'activo') activosCount++;
              });
            %><%= activosCount %></h3>
            <p>Proyectos Activos</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon bg-info">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-content">
            <h3><%
              let completadosCount = 0;
              students.forEach(s => {
                if (s.proyecto_estado === 'completado') completadosCount++;
              });
            %><%= completadosCount %></h3>
            <p>Proyectos Completados</p>
          </div>
        </div>
      </div>

      <div class="students-table-container">
        <% if (students.length === 0) { %>
          <div class="empty-state">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h3>No hay estudiantes asignados</h3>
            <p class="text-muted">Aún no tienes estudiantes en proyectos bajo tu coordinación.</p>
          </div>
        <% } else { %>
          <div class="table-header">
            <h3>Lista de Estudiantes</h3>
            <div class="search-box">
              <input type="text" id="searchStudents" placeholder="Buscar estudiante..." class="form-control">
              <i class="fas fa-search"></i>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table students-table">
              <thead>
                <tr>
                  <th>Estudiante</th>
                  <th>Proyecto</th>
                  <th>Estado del Proyecto</th>
                  <th>Estado del Estudiante</th>
                  <th>Contacto</th>
                  <th>Fecha de Registro</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="studentsTableBody">
                <% students.forEach(student => { %>
                  <tr class="student-row <%= student.activo === false ? 'inactive' : '' %>" data-student-name="<%= student.nombres %> <%= student.apellidos %>" data-project="<%= student.proyecto_titulo %>">
                    <td>
                      <div class="student-info">
                        <div class="student-avatar">
                          <%= student.nombres.charAt(0) %><%= student.apellidos.charAt(0) %>
                        </div>
                        <div class="student-details">
                          <strong><%= student.nombres %> <%= student.apellidos %></strong>
                          <small class="text-muted d-block">ID: <%= student.id %></small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="project-info">
                        <a href="/projects/<%= student.proyecto_id %>" class="project-link">
                          <%= student.proyecto_titulo %>
                        </a>
                      </div>
                    </td>
                    <td>
                      <span class="status-badge status-<%= student.proyecto_estado || 'activo' %>">
                        <%
                          const estado = student.proyecto_estado || 'activo';
                          const estadoCapitalizado = estado.charAt(0).toUpperCase() + estado.slice(1);
                        %>
                        <%= estadoCapitalizado %>
                      </span>
                    </td>
                    <td>
                      <% if (student.activo !== false) { %>
                        <span class="badge bg-success">
                          <i class="fas fa-check-circle me-1"></i>Activo
                        </span>
                      <% } else { %>
                        <span class="badge bg-danger">
                          <i class="fas fa-times-circle me-1"></i>Inactivo
                        </span>
                      <% } %>
                    </td>
                    <td>
                      <div class="contact-info">
                        <div class="contact-item">
                          <i class="fas fa-envelope"></i>
                          <a href="mailto:<%= student.email %>"><%= student.email %></a>
                        </div>
                        <% if (student.telefono) { %>
                          <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <span><%= student.telefono %></span>
                          </div>
                        <% } %>
                      </div>
                    </td>
                    <td>
                      <span class="date-text">
                        <%
                          const fechaRegistro = new Date(student.fecha_registro);
                          const fechaFormateada = fechaRegistro.toLocaleDateString();
                        %>
                        <%= fechaFormateada %>
                      </span>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <a href="/projects/<%= student.proyecto_id %>" class="btn btn-sm btn-primary" title="Ver Proyecto">
                          <i class="fas fa-eye"></i>
                        </a>
                        <% if (student.activo !== false) { %>
                          <button class="btn btn-sm btn-danger" onclick="toggleStudentStatus(<%= student.id %>, '<%= student.nombres %> <%= student.apellidos %>', false)" title="Desactivar Estudiante">
                            <i class="fas fa-user-slash"></i>
                          </button>
                        <% } else { %>
                          <button class="btn btn-sm btn-success" onclick="toggleStudentStatus(<%= student.id %>, '<%= student.nombres %> <%= student.apellidos %>', true)" title="Activar Estudiante">
                            <i class="fas fa-user-check"></i>
                          </button>
                        <% } %>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function contactStudent(email) {
      window.location.href = `mailto:${email}`;
    }

    // Función para desactivar/activar estudiante
    function toggleStudentStatus(studentId, studentName, isActivating) {
      const action = isActivating ? 'activar' : 'desactivar';
      const confirmMessage = `¿Estás seguro de que deseas ${action} al estudiante ${studentName}?`;
      
      if (confirm(confirmMessage)) {
        fetch(`/coordinator/students/${studentId}/toggle-status`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            location.reload(); // Recargar la página para mostrar los cambios
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al cambiar el estado del estudiante');
        });
      }
    }

    // Funcionalidad de búsqueda
    const searchElement = document.getElementById('searchStudents');
    if (searchElement) {
      searchElement.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('.student-row');
        
        rows.forEach(row => {
          const studentName = row.dataset.studentName.toLowerCase();
          const projectName = row.dataset.project.toLowerCase();
          
          if (studentName.includes(searchTerm) || projectName.includes(searchTerm)) {
            row.classList.remove('hidden');
          } else {
            row.classList.add('hidden');
          }
        });
      });
    }
  </script>
</body>
</html>